name: Set GitHub Pages source to gh-pages

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  set-pages-source:
    runs-on: ubuntu-latest
    steps:
      - name: Set Pages source to gh-pages via API
        env:
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          if [ -z "$REPO_TOKEN" ]; then
            echo "ERROR: REPO_TOKEN secret is not set. Add a PAT with 'repo' scope as REPO_TOKEN in repo Secrets.";
            exit 1;
          fi
          echo "Calling GitHub API to set Pages source to gh-pages..."
          curl -s -X PUT \
            -H "Authorization: token $REPO_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pages \
            -d '{"source":{"branch":"gh-pages","path":"/"}}' \
            | jq .

      - name: Verify Pages configuration
        env:
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          echo "Fetching Pages info..."
          curl -s -H "Authorization: token $REPO_TOKEN" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${{ github.repository }}/pages | jq .

      - name: Notify
        run: echo "If this job succeeded, the Pages source should now be set to gh-pages. Visit https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name || github.repository.split('/')[1] }}"
